<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bird Watcher Pro 98</title>
    <style>
      @font-face {
        font-family: 'W95FA';
        src: local('Tahoma'), local('Segoe UI'), local('Arial');
      }

      :root {
        --bg-main: #c0c0c0;
        --bg-dark: #808080;
        --bg-light: #dfdfdf;
        --bg-white: #ffffff;
        --border-light: #ffffff;
        --border-dark: #404040;
        --border-shadow: #808080;
        --title-bar: #000080;
        --title-bar-inactive: #808080;
        --title-text: #ffffff;
        --text-main: #000000;
        --accent-teal: #008080;
        --accent-yellow: #ffff00;
        --link-blue: #0000ff;
        --highlight: #000080;
        --selection: #000080;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: 'Tahoma', 'Segoe UI', 'Arial', sans-serif;
        font-size: 11px;
        background: var(--accent-teal);
        color: var(--text-main);
        min-height: 100vh;
        padding: 8px;
      }

      /* Window styling */
      .window {
        background: var(--bg-main);
        border: 2px solid;
        border-color: var(--border-light) var(--border-dark) var(--border-dark) var(--border-light);
        box-shadow: 1px 1px 0 var(--border-shadow);
        margin-bottom: 8px;
      }

      .window-title {
        background: linear-gradient(90deg, var(--title-bar), var(--accent-teal));
        color: var(--title-text);
        padding: 3px 4px;
        font-weight: bold;
        font-size: 11px;
        display: flex;
        align-items: center;
        gap: 6px;
        user-select: none;
      }

      .window-title .icon {
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
      }

      .window-title .buttons {
        margin-left: auto;
        display: flex;
        gap: 2px;
      }

      .title-btn {
        width: 16px;
        height: 14px;
        background: var(--bg-main);
        border: 1px solid;
        border-color: var(--border-light) var(--border-dark) var(--border-dark) var(--border-light);
        font-size: 9px;
        font-weight: bold;
        line-height: 1;
        cursor: default;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .title-btn:active {
        border-color: var(--border-dark) var(--border-light) var(--border-light) var(--border-dark);
      }

      .window-content {
        padding: 8px;
      }

      /* Inset panel */
      .inset {
        background: var(--bg-white);
        border: 2px solid;
        border-color: var(--border-shadow) var(--border-light) var(--border-light) var(--border-shadow);
        padding: 4px;
      }

      /* Outset panel */
      .outset {
        background: var(--bg-main);
        border: 2px solid;
        border-color: var(--border-light) var(--border-dark) var(--border-dark) var(--border-light);
        padding: 4px;
      }

      /* Status bar */
      .status-bar {
        background: var(--bg-main);
        border-top: 1px solid var(--border-light);
        padding: 2px 4px;
        font-size: 10px;
        display: flex;
        gap: 4px;
      }

      .status-bar-field {
        border: 1px solid;
        border-color: var(--border-shadow) var(--border-light) var(--border-light) var(--border-shadow);
        padding: 1px 4px;
        flex: 1;
      }

      .status-bar-field.fixed {
        flex: none;
        min-width: 100px;
      }

      /* Grid layout */
      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .grid-3 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
      }

      @media (max-width: 800px) {
        .grid-2, .grid-3 {
          grid-template-columns: 1fr;
        }
      }

      /* Stats */
      .stat-label {
        font-size: 10px;
        color: var(--border-dark);
        text-transform: uppercase;
        margin-bottom: 2px;
      }

      .stat-value {
        font-size: 18px;
        font-weight: bold;
        color: var(--title-bar);
      }

      .stat-value.large {
        font-size: 28px;
      }

      /* Lists */
      .list-box {
        background: var(--bg-white);
        border: 2px solid;
        border-color: var(--border-shadow) var(--border-light) var(--border-light) var(--border-shadow);
        max-height: 150px;
        overflow-y: auto;
        font-size: 11px;
      }

      .list-item {
        padding: 2px 4px;
        border-bottom: 1px solid #eee;
      }

      .list-item:last-child {
        border-bottom: none;
      }

      .list-item:nth-child(even) {
        background: #f8f8f8;
      }

      .list-item.selected {
        background: var(--selection);
        color: white;
      }

      .list-item .rare {
        background: var(--accent-yellow);
        color: #000;
        padding: 0 4px;
        font-size: 9px;
        font-weight: bold;
        margin-left: 4px;
      }

      .list-item .timestamp {
        color: var(--border-dark);
        font-size: 10px;
      }

      /* Video feed */
      .video-container {
        background: #000;
        border: 2px solid;
        border-color: var(--border-shadow) var(--border-light) var(--border-light) var(--border-shadow);
        position: relative;
        aspect-ratio: 4/3;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .video-container img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        image-rendering: auto;
      }

      .video-label {
        position: absolute;
        top: 4px;
        left: 4px;
        background: rgba(0, 0, 0, 0.7);
        color: #0f0;
        padding: 2px 6px;
        font-size: 10px;
        font-family: 'Courier New', monospace;
      }

      .video-status {
        position: absolute;
        bottom: 4px;
        right: 4px;
        background: rgba(0, 0, 0, 0.7);
        padding: 2px 6px;
        font-size: 10px;
        font-family: 'Courier New', monospace;
      }

      .video-status.recording {
        color: #f00;
      }

      .video-status.idle {
        color: #0f0;
      }

      /* Audio visualizer */
      .audio-panel {
        background: #001a00;
        border: 2px solid;
        border-color: var(--border-shadow) var(--border-light) var(--border-light) var(--border-shadow);
        padding: 8px;
        color: #0f0;
        font-family: 'Courier New', monospace;
        font-size: 10px;
      }

      .audio-bars {
        display: flex;
        align-items: flex-end;
        height: 40px;
        gap: 2px;
        margin: 8px 0;
      }

      .audio-bar {
        flex: 1;
        background: linear-gradient(to top, #0f0, #ff0, #f00);
        min-width: 4px;
        transition: height 0.1s ease;
      }

      .audio-info {
        display: flex;
        justify-content: space-between;
        margin-top: 4px;
      }

      /* Detection categories */
      .detection-panel {
        background: #1a1a2e;
        border: 2px solid;
        border-color: var(--border-shadow) var(--border-light) var(--border-light) var(--border-shadow);
        padding: 8px;
        color: #fff;
        font-family: 'Courier New', monospace;
        font-size: 10px;
      }

      .detection-category {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 4px 0;
        border-bottom: 1px solid #333;
      }

      .detection-category:last-child {
        border-bottom: none;
      }

      .category-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
      }

      .category-dot.human { background: #ff0000; }
      .category-dot.bird { background: #00ff00; }
      .category-dot.animal { background: #ffa500; }
      .category-dot.vehicle { background: #ff00ff; }
      .category-dot.object { background: #00ffff; }

      .category-name {
        flex: 1;
        text-transform: uppercase;
      }

      .category-count {
        font-weight: bold;
        min-width: 20px;
        text-align: right;
      }

      .detection-total {
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid #555;
        font-weight: bold;
        text-align: center;
        font-size: 12px;
      }

      /* Buttons */
      .btn {
        background: var(--bg-main);
        border: 2px solid;
        border-color: var(--border-light) var(--border-dark) var(--border-dark) var(--border-light);
        padding: 4px 16px;
        font-family: inherit;
        font-size: 11px;
        cursor: pointer;
      }

      .btn:active {
        border-color: var(--border-dark) var(--border-light) var(--border-light) var(--border-dark);
        padding: 5px 15px 3px 17px;
      }

      .btn:focus {
        outline: 1px dotted #000;
        outline-offset: -4px;
      }

      /* Tabs */
      .tab-bar {
        display: flex;
        gap: 2px;
        margin-bottom: -2px;
        position: relative;
        z-index: 1;
      }

      .tab {
        background: var(--bg-main);
        border: 2px solid;
        border-color: var(--border-light) var(--border-dark) var(--border-dark) var(--border-light);
        border-bottom: none;
        padding: 4px 12px;
        cursor: pointer;
        font-size: 11px;
      }

      .tab.active {
        background: var(--bg-main);
        border-bottom: 2px solid var(--bg-main);
        margin-bottom: -2px;
        position: relative;
      }

      .tab-content {
        border: 2px solid;
        border-color: var(--border-light) var(--border-dark) var(--border-dark) var(--border-light);
        padding: 8px;
        background: var(--bg-main);
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      /* Blinking indicator */
      @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0; }
      }

      .blink {
        animation: blink 1s infinite;
      }

      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 16px;
        height: 16px;
      }

      ::-webkit-scrollbar-track {
        background: repeating-conic-gradient(var(--bg-main) 0% 25%, var(--bg-light) 0% 50%) 50% / 2px 2px;
      }

      ::-webkit-scrollbar-thumb {
        background: var(--bg-main);
        border: 2px solid;
        border-color: var(--border-light) var(--border-dark) var(--border-dark) var(--border-light);
      }

      ::-webkit-scrollbar-button {
        background: var(--bg-main);
        border: 2px solid;
        border-color: var(--border-light) var(--border-dark) var(--border-dark) var(--border-light);
        display: block;
        height: 16px;
        width: 16px;
      }

      /* Main layout */
      .main-window {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header-bar {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
        padding: 4px;
      }

      .logo {
        font-size: 24px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .logo-icon {
        font-size: 28px;
      }

      .section-title {
        font-weight: bold;
        margin-bottom: 8px;
        padding-bottom: 4px;
        border-bottom: 1px solid var(--border-shadow);
      }

      /* Weather panel */
      .weather-panel {
        background: linear-gradient(180deg, #87CEEB 0%, #E0F4FF 100%);
        border: 2px solid;
        border-color: var(--border-shadow) var(--border-light) var(--border-light) var(--border-shadow);
        padding: 12px;
        text-align: center;
      }

      .weather-icon {
        font-size: 48px;
        margin-bottom: 4px;
      }

      .weather-temp {
        font-size: 32px;
        font-weight: bold;
        color: var(--title-bar);
      }

      .weather-temp .unit {
        font-size: 16px;
        font-weight: normal;
      }

      .weather-condition {
        font-size: 12px;
        color: #404040;
        margin-top: 4px;
        text-transform: capitalize;
      }

      .weather-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-top: 12px;
        font-size: 10px;
        text-align: left;
      }

      .weather-detail {
        background: rgba(255, 255, 255, 0.5);
        padding: 4px 8px;
        border-radius: 2px;
      }

      .weather-detail-label {
        color: #666;
        font-size: 9px;
        text-transform: uppercase;
      }

      .weather-detail-value {
        font-weight: bold;
        color: #000;
      }

      .weather-unavailable {
        color: #808080;
        font-style: italic;
        padding: 20px;
      }

      .grid-4 {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
      }

      @media (max-width: 900px) {
        .grid-4 {
          grid-template-columns: repeat(2, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <div class="main-window">
      <!-- Main Window -->
      <div class="window">
        <div class="window-title">
          <span class="icon">üê¶</span>
          <span>Bird Watcher Pro 98 - Live Monitoring Station</span>
          <div class="buttons">
            <button class="title-btn">_</button>
            <button class="title-btn">‚ñ°</button>
            <button class="title-btn">√ó</button>
          </div>
        </div>
        <div class="window-content">
          <!-- Stats Row -->
          <div class="grid-4" style="margin-bottom: 12px;">
            <div class="outset" style="text-align: center; padding: 12px;">
              <div class="stat-label">Total Sightings</div>
              <div class="stat-value large" id="total-sightings">0</div>
            </div>
            <div class="outset" style="text-align: center; padding: 12px;">
              <div class="stat-label">Most Common Species</div>
              <div class="stat-value" id="most-common" style="font-size: 14px;">N/A</div>
            </div>
            <div class="outset" style="text-align: center; padding: 12px;">
              <div class="stat-label">Active Cameras</div>
              <div class="stat-value large" id="camera-count">{{ cameras|length }}</div>
            </div>
            <!-- Weather Widget -->
            <div class="weather-panel" id="weather-panel">
              <div class="weather-icon" id="weather-icon">üå§Ô∏è</div>
              <div class="weather-temp">
                <span id="weather-temp">--</span><span class="unit">¬∞C</span>
              </div>
              <div class="weather-condition" id="weather-condition">Loading...</div>
              <div class="weather-details">
                <div class="weather-detail">
                  <div class="weather-detail-label">Feels Like</div>
                  <div class="weather-detail-value"><span id="weather-feels">--</span>¬∞C</div>
                </div>
                <div class="weather-detail">
                  <div class="weather-detail-label">Humidity</div>
                  <div class="weather-detail-value"><span id="weather-humidity">--</span>%</div>
                </div>
                <div class="weather-detail">
                  <div class="weather-detail-label">Wind</div>
                  <div class="weather-detail-value"><span id="weather-wind">--</span> m/s</div>
                </div>
                <div class="weather-detail">
                  <div class="weather-detail-label">Clouds</div>
                  <div class="weather-detail-value"><span id="weather-clouds">--</span>%</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Main content grid -->
          <div class="grid-2">
            <!-- Left Column - Video Feeds -->
            <div>
              <div class="section-title">üìπ Live Camera Feeds</div>
              {% if cameras %}
                {% for cam in cameras %}
                <div class="video-container" style="margin-bottom: 8px;">
                  <img src="/video_feed/{{ cam.id }}" alt="Camera {{ cam.id }} Feed" />
                  <div class="video-label">CAM {{ cam.id }}</div>
                  <div class="video-status idle" id="cam-status-{{ cam.id }}">‚óè LIVE</div>
                </div>
                {% endfor %}
              {% else %}
                <div class="video-container">
                  <img src="/video_feed/0" alt="Camera Feed" />
                  <div class="video-label">CAM 0</div>
                  <div class="video-status idle">‚óè STANDBY</div>
                </div>
              {% endif %}

              <!-- Audio Panel -->
              <div class="section-title" style="margin-top: 12px;">üé§ Audio Monitor</div>
              <div class="audio-panel">
                <div style="display: flex; justify-content: space-between;">
                  <span>AUDIO INPUT</span>
                  <span id="audio-status" class="blink">‚óè LISTENING</span>
                </div>
                <div class="audio-bars" id="audio-bars">
                  <div class="audio-bar" style="height: 10%;"></div>
                  <div class="audio-bar" style="height: 15%;"></div>
                  <div class="audio-bar" style="height: 25%;"></div>
                  <div class="audio-bar" style="height: 40%;"></div>
                  <div class="audio-bar" style="height: 60%;"></div>
                  <div class="audio-bar" style="height: 45%;"></div>
                  <div class="audio-bar" style="height: 30%;"></div>
                  <div class="audio-bar" style="height: 50%;"></div>
                  <div class="audio-bar" style="height: 35%;"></div>
                  <div class="audio-bar" style="height: 20%;"></div>
                  <div class="audio-bar" style="height: 25%;"></div>
                  <div class="audio-bar" style="height: 15%;"></div>
                </div>
                <div class="audio-info">
                  <span>Species: <span id="audio-species">--</span></span>
                  <span>Confidence: <span id="audio-confidence">--</span></span>
                </div>
              </div>

              <!-- Live Detections Panel -->
              <div class="section-title" style="margin-top: 12px;">üéØ Live Detections</div>
              <div class="detection-panel" id="detection-panel">
                <div class="detection-category">
                  <div class="category-dot human"></div>
                  <span class="category-name">Human</span>
                  <span class="category-count" id="count-human">0</span>
                </div>
                <div class="detection-category">
                  <div class="category-dot bird"></div>
                  <span class="category-name">Bird</span>
                  <span class="category-count" id="count-bird">0</span>
                </div>
                <div class="detection-category">
                  <div class="category-dot animal"></div>
                  <span class="category-name">Animal</span>
                  <span class="category-count" id="count-animal">0</span>
                </div>
                <div class="detection-category">
                  <div class="category-dot vehicle"></div>
                  <span class="category-name">Vehicle</span>
                  <span class="category-count" id="count-vehicle">0</span>
                </div>
                <div class="detection-category">
                  <div class="category-dot object"></div>
                  <span class="category-name">Object</span>
                  <span class="category-count" id="count-object">0</span>
                </div>
                <div class="detection-total">
                  Total: <span id="detection-total">0</span>
                </div>
              </div>
            </div>

            <!-- Right Column - Data -->
            <div>
              <!-- Species Count -->
              <div class="section-title">ü¶Ö Species Detected</div>
              <div class="list-box" id="species-list" style="margin-bottom: 12px;">
                <div class="list-item" style="color: #808080;">Loading...</div>
              </div>

              <!-- Recent Sightings -->
              <div class="section-title">üìã Recent Sightings</div>
              <div class="list-box" id="sightings-list" style="max-height: 200px;">
                <div class="list-item" style="color: #808080;">Loading...</div>
              </div>

              <!-- Migration Data -->
              <div class="section-title" style="margin-top: 12px;">üó∫Ô∏è Migration Peaks</div>
              <div class="list-box" id="migration-list">
                <div class="list-item" style="color: #808080;">Loading...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
          <div class="status-bar-field" id="status-message">Ready</div>
          <div class="status-bar-field fixed" id="status-time">--:--:--</div>
        </div>
      </div>

      <!-- Help text -->
      <div class="window" style="padding: 0;">
        <div class="window-title" style="background: linear-gradient(90deg, var(--title-bar-inactive), #666);">
          <span class="icon">üí°</span>
          <span>Tips</span>
        </div>
        <div class="window-content" style="font-size: 10px; color: #404040;">
          Dashboard auto-refreshes every 5 seconds. Live video streams at ~10 FPS. 
          Audio analysis runs when birds are detected. Yellow badges indicate rare species.
        </div>
      </div>
    </div>

    <script>
      // Update clock
      function updateClock() {
        const now = new Date();
        document.getElementById('status-time').textContent = now.toLocaleTimeString();
      }
      setInterval(updateClock, 1000);
      updateClock();

      // Animate audio bars (simulated when no real data)
      function animateAudioBars() {
        const bars = document.querySelectorAll('.audio-bar');
        bars.forEach(bar => {
          const height = Math.random() * 80 + 10;
          bar.style.height = height + '%';
        });
      }
      setInterval(animateAudioBars, 150);

      // Fetch and update data
      async function refresh() {
        try {
          const res = await fetch('/api/stats');
          const data = await res.json();

          // Update stats
          document.getElementById('total-sightings').textContent = data.stats.total_sightings || 0;
          document.getElementById('most-common').textContent = data.stats.most_common_species || 'N/A';
          document.getElementById('status-message').textContent = 
            `Last update: ${new Date().toLocaleTimeString()} | Total: ${data.stats.total_sightings || 0} sightings`;

          // Update species list
          const speciesList = document.getElementById('species-list');
          const speciesCount = data.stats.species_count || {};
          if (Object.keys(speciesCount).length > 0) {
            speciesList.innerHTML = '';
            Object.entries(speciesCount)
              .sort((a, b) => b[1] - a[1])
              .forEach(([species, count]) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `<strong>${species}</strong>: ${count} sighting${count !== 1 ? 's' : ''}`;
                speciesList.appendChild(div);
              });
          } else {
            speciesList.innerHTML = '<div class="list-item" style="color: #808080;">No species detected yet</div>';
          }

          // Update recent sightings
          const sightingsList = document.getElementById('sightings-list');
          const recent = data.recent || [];
          if (recent.length > 0) {
            sightingsList.innerHTML = '';
            recent.reverse().forEach(item => {
              const div = document.createElement('div');
              div.className = 'list-item';
              const camera = item.camera_id !== undefined ? `Cam ${item.camera_id}` : '';
              const rareTag = item.is_rare ? '<span class="rare">RARE</span>' : '';
              const time = item.timestamp ? new Date(item.timestamp).toLocaleString() : '';
              div.innerHTML = `
                <span class="timestamp">${time}</span><br/>
                <strong>${item.species}</strong> ${camera} ${rareTag}
              `;
              sightingsList.appendChild(div);
            });
          } else {
            sightingsList.innerHTML = '<div class="list-item" style="color: #808080;">No sightings yet</div>';
          }

          // Update migration peaks
          const migrationList = document.getElementById('migration-list');
          const peaks = (data.migration && data.migration.peak_months) || {};
          if (Object.keys(peaks).length > 0) {
            migrationList.innerHTML = '';
            Object.entries(peaks).forEach(([species, month]) => {
              const div = document.createElement('div');
              div.className = 'list-item';
              div.innerHTML = `<strong>${species}</strong>: Peak in ${month}`;
              migrationList.appendChild(div);
            });
          } else {
            migrationList.innerHTML = '<div class="list-item" style="color: #808080;">Insufficient data</div>';
          }

        } catch (err) {
          document.getElementById('status-message').textContent = 'Error fetching data: ' + err.message;
        }
      }

      // Fetch audio status
      async function refreshAudio() {
        try {
          const res = await fetch('/api/audio');
          const data = await res.json();
          if (data.species) {
            document.getElementById('audio-species').textContent = data.species;
            document.getElementById('audio-confidence').textContent = 
              data.confidence ? (data.confidence * 100).toFixed(1) + '%' : '--';
            document.getElementById('audio-status').textContent = '‚óè DETECTED';
            document.getElementById('audio-status').style.color = '#ff0';
          } else {
            document.getElementById('audio-species').textContent = '--';
            document.getElementById('audio-confidence').textContent = '--';
            document.getElementById('audio-status').textContent = '‚óè LISTENING';
            document.getElementById('audio-status').style.color = '#0f0';
          }
        } catch (err) {
          // Silently fail for audio status
        }
      }

      // Fetch weather data
      async function refreshWeather() {
        try {
          const res = await fetch('/api/weather');
          const data = await res.json();
          
          console.log('Weather data:', data);  // Debug logging

          // Check if weather is configured and has no error
          if (data.error || data.configured === false) {
            document.getElementById('weather-condition').textContent = data.configured === false ? 'Not configured' : 'Error';
            document.getElementById('weather-icon').textContent = '‚ùì';
            document.getElementById('weather-temp').textContent = '--';
            document.getElementById('weather-feels').textContent = '--';
            document.getElementById('weather-humidity').textContent = '--';
            document.getElementById('weather-wind').textContent = '--';
            document.getElementById('weather-clouds').textContent = '--';
            return;
          }

          // Update temperature
          if (data.temperature !== null && data.temperature !== undefined) {
            document.getElementById('weather-temp').textContent = Math.round(data.temperature);
          } else {
            document.getElementById('weather-temp').textContent = '--';
          }

          // Update condition
          document.getElementById('weather-condition').textContent = data.conditions || 'Unknown';

          // Update feels like
          if (data.feels_like !== null && data.feels_like !== undefined) {
            document.getElementById('weather-feels').textContent = Math.round(data.feels_like);
          } else {
            document.getElementById('weather-feels').textContent = '--';
          }

          // Update humidity
          if (data.humidity !== null && data.humidity !== undefined) {
            document.getElementById('weather-humidity').textContent = data.humidity;
          } else {
            document.getElementById('weather-humidity').textContent = '--';
          }

          // Update wind
          if (data.wind_speed !== null && data.wind_speed !== undefined) {
            document.getElementById('weather-wind').textContent = data.wind_speed.toFixed(1);
          } else {
            document.getElementById('weather-wind').textContent = '--';
          }

          // Update clouds
          if (data.clouds !== null && data.clouds !== undefined) {
            document.getElementById('weather-clouds').textContent = data.clouds;
          } else {
            document.getElementById('weather-clouds').textContent = '--';
          }

          // Update weather icon based on conditions
          const condition = (data.conditions || '').toLowerCase();
          let icon = 'üå§Ô∏è';
          if (condition.includes('clear') || condition.includes('sunny')) {
            icon = '‚òÄÔ∏è';
          } else if (condition.includes('cloud') || condition.includes('overcast')) {
            icon = '‚òÅÔ∏è';
          } else if (condition.includes('rain') || condition.includes('drizzle')) {
            icon = 'üåßÔ∏è';
          } else if (condition.includes('thunder') || condition.includes('storm')) {
            icon = '‚õàÔ∏è';
          } else if (condition.includes('snow')) {
            icon = '‚ùÑÔ∏è';
          } else if (condition.includes('fog') || condition.includes('mist') || condition.includes('haze')) {
            icon = 'üå´Ô∏è';
          } else if (condition.includes('wind')) {
            icon = 'üí®';
          } else if (condition.includes('partly')) {
            icon = '‚õÖ';
          }
          document.getElementById('weather-icon').textContent = icon;

          // Update panel background based on temperature
          const temp = data.temperature;
          const panel = document.getElementById('weather-panel');
          if (temp !== null && temp !== undefined) {
            if (temp <= 0) {
              panel.style.background = 'linear-gradient(180deg, #E8F4FF 0%, #C8E4FF 100%)';
            } else if (temp <= 10) {
              panel.style.background = 'linear-gradient(180deg, #D4EDFF 0%, #B8DFFF 100%)';
            } else if (temp <= 20) {
              panel.style.background = 'linear-gradient(180deg, #87CEEB 0%, #E0F4FF 100%)';
            } else if (temp <= 30) {
              panel.style.background = 'linear-gradient(180deg, #FFE4B5 0%, #FFFACD 100%)';
            } else {
              panel.style.background = 'linear-gradient(180deg, #FFB347 0%, #FFCC80 100%)';
            }
          } else {
            panel.style.background = 'linear-gradient(180deg, #C0C0C0 0%, #808080 100%)';
          }

        } catch (err) {
          document.getElementById('weather-condition').textContent = 'Error loading';
          document.getElementById('weather-icon').textContent = '‚ö†Ô∏è';
          console.error('Weather fetch error:', err);
        }
      }

      // Fetch live detections
      async function refreshDetections() {
        try {
          const res = await fetch('/api/detections');
          const data = await res.json();

          // Aggregate counts across all cameras
          const counts = {
            human: 0,
            bird: 0,
            animal: 0,
            vehicle: 0,
            object: 0
          };
          let total = 0;

          Object.values(data).forEach(camData => {
            if (camData.detections) {
              camData.detections.forEach(det => {
                const category = det.category || 'object';
                if (counts.hasOwnProperty(category)) {
                  counts[category]++;
                } else {
                  counts.object++;
                }
                total++;
              });
            }
          });

          // Update the UI
          document.getElementById('count-human').textContent = counts.human;
          document.getElementById('count-bird').textContent = counts.bird;
          document.getElementById('count-animal').textContent = counts.animal;
          document.getElementById('count-vehicle').textContent = counts.vehicle;
          document.getElementById('count-object').textContent = counts.object;
          document.getElementById('detection-total').textContent = total;

          // Highlight active categories
          const categories = ['human', 'bird', 'animal', 'vehicle', 'object'];
          categories.forEach(cat => {
            const countEl = document.getElementById(`count-${cat}`);
            if (counts[cat] > 0) {
              countEl.style.color = getColorForCategory(cat);
              countEl.style.textShadow = `0 0 6px ${getColorForCategory(cat)}`;
            } else {
              countEl.style.color = '#666';
              countEl.style.textShadow = 'none';
            }
          });

          // Flash total if there are detections
          const totalEl = document.getElementById('detection-total');
          if (total > 0) {
            totalEl.style.color = '#0f0';
          } else {
            totalEl.style.color = '#888';
          }

        } catch (err) {
          // Silently fail for detections
        }
      }

      function getColorForCategory(category) {
        const colors = {
          human: '#ff0000',
          bird: '#00ff00',
          animal: '#ffa500',
          vehicle: '#ff00ff',
          object: '#00ffff'
        };
        return colors[category] || '#ffffff';
      }

      // Initial load and periodic refresh
      refresh();
      refreshAudio();
      refreshWeather();
      refreshDetections();
      setInterval(refresh, 5000);
      setInterval(refreshAudio, 2000);
      setInterval(refreshWeather, 60000);  // Weather updates every minute
      setInterval(refreshDetections, 500);  // Detections update quickly
    </script>
  </body>
</html>
